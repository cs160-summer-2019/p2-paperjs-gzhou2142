{% load static %}
<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>P3 Coloring</title>
  <script type="text/javascript" src="{% static 'coloring/vendors/jquery/jquery-3.3.1.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'coloring/vendors/paper/paper-full.min.js' %}"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <style type="text/css">
    #undo{
      position:absolute;
      bottom:10px;
      left: 42%;
    }
    
    #redo{
      position:absolute;
      bottom:10px;
      left:52%;
    }
    
    #color-palette {
      width: 250px;
      background-color: #f1f1f1;
      display: flex;
      flex-wrap: wrap;
      position: absolute;
      bottom: 0;
      right: 0;
    }

    .swatch {
      width: 40px;
      height: 40px;
      -moz-border-radius: 18px;
      -webkit-border-radius: 18px;
      border-radius: 18px;
      margin: 3px;
    }

    #myCanvas {
      padding-left: 0;
      padding-right: 0;
      margin-left: auto;
      margin-right: auto;
      margin-top:130px;
      display: block;
      
    }

    .wrapper {
      display: flex;
      align-items: stretch;
    }

    #sidebar {
      border-radius: 25px;
      min-width: 15%;
      max-width: 15%;
      min-height: 80vh;
      position: absolute;
      top: 10vh;
    }

    #sidebar.active {
      margin-left: -14.5%;
    }

    a[data-toggle="collapse"] {
      position: relative;
    }

    .dropdown-toggle::after {
      display: block;
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
    }

    @import "https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700";
    #sidebarCollapse {
      position: absolute;
      top: 0%;
      margin-top: 1%;
      margin-left:1%;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #fafafa;
    }

    p {
      font-family: 'Poppins', sans-serif;
      font-size: 1.1em;
      font-weight: 300;
      line-height: 1.7em;
      color: #999;
    }

    a,
    a:hover,
    a:focus {
      color: inherit;
      text-decoration: none;
      transition: all 0.3s;
    }

    #sidebar {
      /* don't forget to add all the previously mentioned styles here too */
      background: #f1f1f1;
      border-style: solid;
      border-width: 1px;
      border-color:black;
      color: #fff;
      transition: all 0.3s;
    }

    #sidebar .sidebar-header {
      border-radius: 50px;
      padding: 20px;
      background: #25347D;
    }
    
    #alternating-first {
      background: #f1f1f1;
      color:black;
      border-top: 1px solid black;
      border-bottom: 1px solid black;
    }
    
    #alternating-second{
      background: #f1f1f1;
      color:black;
      border-top: 1px solid black;
      border-bottom: 1px solid black;
    }

    #sidebar ul.components {
      padding: 0 0;
      transform: translateY(15%);
      border-bottom: 1px solid #47748b;
    }

    #sidebar ul p {
      color: #fff;
      padding: 10px;
    }

    #sidebar ul li a {
      padding-top:3.5vh;
      padding-bottom:3.5vh;
      padding-left:30px;
      font-size: 1.3vw;
      display: block;
    }

    #sidebar ul li a:hover {
      color: #7386D5;
      background: #fff;
    }

    #sidebar ul li.active>a,
    a[aria-expanded="true"] {
      color: #fff;
      background: #6d7fcc;
    }

    ul ul a {
      font-size: 0.9em !important;
      padding-left: 30px !important;
      background: #6d7fcc;
    }
  </style>
  <script type="text/javascript" canvas="canvas">
    window.onload = function() {
      var coloringHistoryPointer = -1;
      // array to store coloring actions
      var coloringHistory = new Array();
      // array to store history of colorings at a specific location
      // eg. at location with id=x its coloring history can be [red, blue, green]. 
      // green being most recent.
      var IdHistory = new Array();
      var currentColor = "#F44336";
      var canvas = document.getElementById('myCanvas');
      // coloring page
      var mandala = {
        item: null,
        lastClicked: null,
        filePath: '/static/coloring/images/mandala-freepik.svg'
      };
      // color palette
      var cp = {
        history: ["#000000"], // black selected by default
        options: [],
        $container: $('#color-palette')
      }

      cp.history.push("#F44336");
      var color1 = 'red';
      var color2 = 'red';
      // your rectangle gradient interaction goes in this function
      // you may also add code outside of the function (e.g., global variables)
      function myGradientInteraction() {
        var tool = new paper.Tool();
        var path = new paper.Path();
        path.add(new paper.Point(120, 120));
        path.add(new paper.Point(480, 120));
        path.add(new paper.Point(480, 240));
        path.add(new paper.Point(120, 240));
        path.closed = true;
        path.strokeColor = 'black';
        path.strokeWidth = 5;
        path.fillColor = 'red';
        path.view.draw();
        var start;
        tool.onMouseDown = function(event) {
          start = event.point;

        }
        tool.onMouseUp = function(event) {

          var color1 = cp.history[cp.history.length - 2];
          var color2 = cp.history[cp.history.length - 1];
          path.fillColor = {
            gradient: {
              stops: [color1, color2]

            },
            origin: start,
            destination: event.point
          };

        }
      }
      // your custom interaction goes here!
      // you may replace everything
      function myCustomInteraction() {
        var tool = new paper.Tool();
        tool.onMouseDown = function(event) {
          var hit = mandala.item.hitTest(event.point, {
            tolerance: 10,
            fill: true,
          });
          if (hit) {   
            var action = new Action(hit.item.id, event.point, hit);
            insertColorToId(IdHistory, hit.item.id, currentColor);
            coloringHistory = coloringHistory.slice(0, coloringHistoryPointer + 1);
            coloringHistory.push(action);
            coloringHistoryPointer += 1;
            hit.item.fillColor = cp.history[cp.history.length - 1];
          }
        }
      }
      // create a color palette with the given colors
      var previous = null;
      var first = null;
      function createColorPalette(colors) {
        // create a swatch for each color
        for (var i = colors.length - 1; i >= 0; i--) {
          var $swatch = $("<div>").css("background-color", colors[i])
            .addClass("swatch");
          
          $swatch.click(function() {
            // add color to the color palette history
            if (previous != null) {
              previous.style.border = "none";
            }
            this.style.border = "solid 4px #000000";
            previous = this;
            currentColor = $(this).css("background-color");
            cp.history.push($(this).css("background-color"));
          });
          cp.$container.append($swatch);
          var firstSwatch = $(".swatch")[0];
          firstSwatch.style.border = "solid 4px #000000";
          previous = firstSwatch;
        }
        
      }
      // loads a set of colors from a json to create a color palette
      function getColorsCreatePalette() {
        cp.$container.html(" ");
        $.getJSON('/static/coloring/vendors/material/material-colors.json', function(colors) {
          var keys = Object.keys(colors);
          for (var i = keys.length - 1; i >= 0; i--) {
            cp.options.push(colors[keys[i]][500]);
          }
          createColorPalette(cp.options);
        });
      }

      function init(custom) {
        paper.setup(canvas);
        getColorsCreatePalette();
        paper.project.importSVG(mandala.filePath, function(item) {
          mandala.item = item._children["design-freepik"];
          paper.project.insertLayer(0, mandala.item);
          if (custom) {
            myCustomInteraction();
          } else {
            myGradientInteraction();
          }

        });
      }
      // To see your myGradientInteraction version visit: 
      // http://<your url>:8000/coloring/?type=gradient
      // To see your myCustomInteraction version visit: 
      // http://<your url>:8000/coloring/
      var url = window.location.href;
      if (url.indexOf("gradient") > -1) {
        init(false);
      } else {
        init(true);
      }
      
      // Redo the most recent action. 
      function redo(colorHistory, idHistory) {
        var redoAction;
        if (coloringHistoryPointer + 2 > coloringHistory.length) {
          return;
        } else {
          redoAction = colorHistory[coloringHistoryPointer + 1];
          coloringHistoryPointer += 1;
        }
        var id = getId(idHistory, redoAction.id);
        var nextColor;
        if (id.current + 2 > id.colorHistory.length) {
          return;
        } else {
          nextColor = id.colorHistory[id.current + 1];
          id.current += 1;
        }
        if (redoAction.hit && nextColor) {
          redoAction.hit.item.fillColor = nextColor;
        }
      }
      
      //undo the most recent action
      function undo(colorHistory, idHistory) {
        var lastAction;
        if (coloringHistoryPointer >= 0) {
          lastAction = colorHistory[coloringHistoryPointer];
        } else {
          return;
        }

        var id = getId(idHistory, lastAction.id);
        var previousColor;
        if (id.current >= 1) {
           previousColor = id.colorHistory[id.current - 1];
          id.current -= 1;
        } else {
          return;
        }
        if (lastAction.hit && previousColor) {
          lastAction.hit.item.fillColor = previousColor;
          coloringHistoryPointer -= 1;
        }
      }
      
      $("#undo").click(function() {
        undo(coloringHistory, IdHistory);
      });
      
      $("#redo").click(function() {
        redo(coloringHistory, IdHistory);
      })
    }
    
    
    
    
    
    
    // insert Id objects with color into array. Makes sure id is unique.
    function insertColorToId(array, id, color) {
        var i;
        var found = false;
        for (i = 0; i < array.length; i++) {
          var curr = array[i];
          if (curr.id == id) {
            curr.colorHistory.push(color);
            curr.current += 1;
            found = true;
          }
        }
      if (found == false) {
        var newId = new Id(id);
        newId.colorHistory.push(color);
        newId.current+=1;
        array.push(newId);
      }
    }
    
    function getId(array, id) {
      var i;
      for (i = 0; i < array.length; i++) {
        var curr = array[i];
        if (curr.id == id) {
          return curr;
        }
      }
      return null;
    }
    
    // Id object to represent each coloring spot on the coloring book. Also stores
    // the history of colors for that specific location.
    function Id (id) {
      this.id = id;
      this.current = 0;
      this.colorHistory = new Array();
      this.colorHistory.push("rgb(255,255,255)");
    }
    
    // Action object to represent an action done by the user. With the id of the location,
    // the point object, and the HitResult being stored.
    function Action(id, point, hit) {
      this.id = id;
      this.point = point;
      this.hit = hit;
    }
    

    // Button to open left side bar
    $(document).ready(function() {
      $('#sidebarCollapse').on('click', function() {
        $('#sidebar').toggleClass('active');
      });

    });
  </script>
</head>

<body>
  <canvas id="myCanvas" width="750px" height="750px"></canvas>
  <div id="color-palette"></div>
  <div class="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar">
      
      <ul class="list-unstyled components">
        <li>
          <a href="#" id = "alternating-first">Paint Brush</a>
        </li>
        <li>
          <a href="#" id = "alternating-second">Pencil</a>
        </li>
        <li>
          <a href="#" id = "alternating-first">Fountain Pen</a>
        </li>
        <li>
          <a href="#"id = "alternating-second">Bucket Fill</a>
        </li>
        <li>
          <a href="#" id = "alternating-first">Crayon</a>
        </li>
        <li>
          <a href="#" id = "alternating-second">Marker</a>
        </li>
      </ul>
    </nav>
  </div>
  <button type="button" id="sidebarCollapse" class="btn btn-info  btn-primary btn-lg">
               <i class="fas fa-align-left"></i>
               <span>></span>
               </button>
    <button type="button" class="btn btn-primary" id="undo">Undo</button>
    <button type="button" class="btn btn-primary" id="redo">Redo</button>


</body>

</html>